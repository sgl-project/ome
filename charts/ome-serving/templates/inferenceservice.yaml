{{- range $modelName, $model := .Values.models }}
{{- if $model.enabled }}
{{- $namespace := $modelName }}
{{- if $model.namespaceScope }}
{{-   $namespace = $model.namespace | default $modelName }}
{{- end }}
{{/*
  Detect PD mode: either explicitly set via pdMode field, or auto-detected from model name ending with "-pd"
  PD mode requires both decoder and router
  Non-PD mode can optionally include router (but not decoder)
*/}}
{{- $isPdMode := or $model.pdMode (hasSuffix "-pd" $modelName) }}
{{/*
  Helper to get replica values - supports both nested (engine.minReplicas) and flat (minReplicas) format
*/}}
{{- $engineMinReplicas := coalesce (dig "engine" "minReplicas" nil $model) $model.minReplicas $.Values.defaults.minReplicas }}
{{- $engineMaxReplicas := coalesce (dig "engine" "maxReplicas" nil $model) $model.maxReplicas $.Values.defaults.maxReplicas }}
{{- $decoderMinReplicas := coalesce (dig "decoder" "minReplicas" nil $model) $.Values.defaults.minReplicas }}
{{- $decoderMaxReplicas := coalesce (dig "decoder" "maxReplicas" nil $model) $.Values.defaults.maxReplicas }}
{{- $routerMinReplicas := coalesce (dig "router" "minReplicas" nil $model) $.Values.defaults.minReplicas }}
{{- $routerMaxReplicas := coalesce (dig "router" "maxReplicas" nil $model) $.Values.defaults.maxReplicas }}
---
apiVersion: v1
kind: Namespace
metadata:
  name: {{ $namespace }}
  labels:
    {{- include "ome-serving.labels" $ | nindent 4 }}
---
apiVersion: ome.io/v1beta1
kind: InferenceService
metadata:
  name: {{ $modelName }}
  namespace: {{ $namespace }}
  labels:
    {{- include "ome-serving.labels" $ | nindent 4 }}
spec:
  model:
    name: {{ $modelName }}
  engine:
    minReplicas: {{ $engineMinReplicas }}
    maxReplicas: {{ $engineMaxReplicas }}
{{- if $isPdMode }}
  decoder:
    minReplicas: {{ $decoderMinReplicas }}
    maxReplicas: {{ $decoderMaxReplicas }}
  router:
    minReplicas: {{ $routerMinReplicas }}
    maxReplicas: {{ $routerMaxReplicas }}
{{- else }}
{{/* Non-PD mode: router is optional, decoder is not allowed */}}
{{- if $model.router }}
  router:
    minReplicas: {{ $routerMinReplicas }}
    maxReplicas: {{ $routerMaxReplicas }}
{{- end }}
{{- end }}
{{- end }}
{{- end }}
