name: PR Validation

on:
  pull_request:
    branches: [ main, release-* ]
    types: [ opened, synchronize, reopened ]

permissions:
  contents: read
  pull-requests: write
  checks: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  quick-checks:
    name: Quick Checks
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.1'
          cache: true

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/go/pkg/mod
            ~/.cache/go-build
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Install dependencies
        run: |
          make controller-gen
          make envtest

      - name: Run fmt and vet
        run: |
          make fmt
          make vet
          git diff --exit-code || (echo "::error::Code is not formatted. Please run 'make fmt'" && exit 1)

      - name: Run linter
        run: make ci-lint

  test-and-build:
    name: Test and Build
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: quick-checks
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.1'
          cache: true

      - name: Cache test dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/go/pkg/mod
            ~/.cache/go-build
            bin/
          key: ${{ runner.os }}-test-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-test-
            ${{ runner.os }}-go-

      - name: Generate code and manifests
        run: |
          make generate
          make manifests
          git diff --exit-code || (echo "::warning::Generated files are out of sync. Please run 'make generate manifests'" && exit 1)

      - name: Run tests
        run: |
          make test
          make coverage

      - name: Upload test coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            coverage-*.out
          retention-days: 7

      - name: Build binaries
        run: |
          make ome-manager
          make model-agent

      - name: Comment PR with test results
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const fs = require('fs');
            let comment = '## üß™ Test Results\n\n';
            
            // Add test status
            if (context.job.status === 'success') {
              comment += '‚úÖ All tests passed!\n\n';
            } else {
              comment += '‚ùå Some tests failed. Please check the logs.\n\n';
            }
            
            // Try to add coverage info if available
            try {
              const coverageFiles = ['coverage-cmd.out', 'coverage-pkg.out', 'coverage-internal.out'];
              let coverageInfo = '### üìä Coverage Report\n\n';
              let hasCoverage = false;
              
              for (const file of coverageFiles) {
                if (fs.existsSync(file)) {
                  hasRegistry = true;
                  // In a real scenario, you'd parse the coverage file
                  coverageInfo += `- ${file.replace('coverage-', '').replace('.out', '')}: Available\n`;
                }
              }
              
              if (hasRegistry) {
                comment += coverageInfo;
              }
            } catch (e) {
              console.log('Could not read coverage files');
            }
            
            // Find and update or create comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && comment.body.includes('Test Results')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

  docker-validation:
    name: Docker Build Validation
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: quick-checks
    strategy:
      matrix:
        image: [ome-image, model-agent-image]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.1'
          cache: true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          make ${{ matrix.image }}
        env:
          TAG: pr-${{ github.event.pull_request.number }}-${{ github.run_number }}
          REGISTRY: local

  helm-validation:
    name: Helm Chart Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: quick-checks
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Lint Helm charts
        run: make helm-lint

      - name: Test Helm chart rendering
        run: |
          helm template test ./charts/ome --debug

  summary:
    name: PR Validation Summary
    runs-on: ubuntu-latest
    needs: [quick-checks, test-and-build, docker-validation, helm-validation]
    if: always()
    steps:
      - name: PR Status Summary
        uses: actions/github-script@v7
        with:
          script: |
            const needs = context.payload.workflow_run ? 
              context.payload.workflow_run.pull_requests[0].number : 
              context.issue.number;
            
            const jobs = {
              'quick-checks': '${{ needs.quick-checks.result }}',
              'test-and-build': '${{ needs.test-and-build.result }}',
              'docker-validation': '${{ needs.docker-validation.result }}',
              'helm-validation': '${{ needs.helm-validation.result }}'
            };
            
            let allPassed = true;
            let summary = '## üìã PR Validation Summary\n\n';
            
            for (const [job, status] of Object.entries(jobs)) {
              const emoji = status === 'success' ? '‚úÖ' : status === 'skipped' ? '‚è≠Ô∏è' : '‚ùå';
              summary += `${emoji} **${job}**: ${status}\n`;
              if (status !== 'success' && status !== 'skipped') {
                allPassed = false;
              }
            }
            
            summary += '\n';
            summary += allPassed ? 
              '### ‚úÖ All checks passed! Ready for review.' : 
              '### ‚ùå Some checks failed. Please review the errors above.';
            
            core.summary.addRaw(summary).write();